<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>マグマ再結晶シミュレーター v1.1.2</title>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            background-color: #121212; color: #eee; 
        }
        
        .wrapper { 
            display: flex; flex-direction: column; 
            height: 100vh; padding: 5px 10px; box-sizing: border-box; 
        }


        h1 { margin: 5px 0; font-size: 1.2rem; letter-spacing: 1px; color: #fff; }
        
        .controls { 
            background: #252525; padding: 8px; border-radius: 8px; 
            margin-bottom: 5px; border: 1px solid #333;
        }


        select, button { padding: 8px 15px; font-size: 0.95rem; border-radius: 6px; border: none; cursor: pointer; }
        select { background: #444; color: white; margin-right: 10px; }
        button { background: #d35400; color: white; font-weight: bold; }
        button:hover { background: #e67e22; }
        button:disabled { background: #444; cursor: not-allowed; }


        .container { 
            display: flex; justify-content: center; gap: 10px; 
            flex: 1; min-height: 0; /* キャンバスの拡大に重要 */
        }


        .panel { 
            background: #1a1a1a; padding: 10px; border-radius: 10px; 
            border: 1px solid #333; flex: 1; 
            display: flex; flex-direction: column; align-items: center;
        }
        
        .rock-info { width: 100%; text-align: center; margin-bottom: 5px; }
        .label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .rock-names { font-size: 1.6rem; color: #f1c40f; font-weight: bold; margin: 0; }


        .canvas-container {
            flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; min-height: 0;
            background: #000; border: 1px solid #444; border-radius: 4px; overflow: hidden;
        }


        canvas { 
            height: 98%; width: auto; 
            aspect-ratio: 1 / 1; image-rendering: pixelated; 
        }
        
        .status-badge { 
            margin-top: 8px; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; 
            width: 90%; text-align: center;
        }
        .waiting { background: #333; color: #666; }
        .cooling { background: #2980b9; color: white; }
        .finished { background: #c0392b; color: white; }
    </style>
</head>
<body>


    <div class="wrapper">
        <h1>火成岩再結晶シミュレーター v1.1.2</h1>
        
        <div class="controls">
            <select id="rockSelect">
                <option value="white">白っぽい（花こう岩・流紋岩）</option>
                <option value="middle">中間的な（閃緑岩・安山岩）</option>
                <option value="black">黒っぽい（斑れい岩・玄武岩）</option>
            </select>
            <button id="startBtn">冷却開始</button>
        </div>


        <div class="container">
            <div class="panel">
                <div class="rock-info">
                    <div class="label">地下深くでゆっくり冷却</div>
                    <div id="nameL" class="rock-names">---</div>
                </div>
                <div class="canvas-container">
                    <canvas id="canvasL" width="400" height="400"></canvas>
                </div>
                <div id="badgeL" class="status-badge waiting">待機中</div>
            </div>
            
            <div class="panel">
                <div class="rock-info">
                    <div class="label">地表付近で急激に冷却</div>
                    <div id="nameR" class="rock-names">---</div>
                </div>
                <div class="canvas-container">
                    <canvas id="canvasR" width="400" height="400"></canvas>
                </div>
                <div id="badgeR" class="status-badge waiting">待機中</div>
            </div>
        </div>
    </div>


<script>
const pairData = {
    white:  { nameL: '花こう岩', nameR: '流紋岩', colors: [[255,255,255], [235,235,235], [255,220,220], [70,70,70]], ground: [170,170,170] },
    middle: { nameL: '閃緑岩',   nameR: '安山岩', colors: [[220,220,220], [170,170,170], [110,110,110], [30,30,30]], ground: [100,100,100] },
    black:  { nameL: '斑れい岩', nameR: '玄武岩', colors: [[120,120,120], [80,80,80], [50,90,50], [15,15,15]], ground: [40,40,40] }
};


let seedsL = [], seedsR = [];
let tL = 0, tR = 0, animId = null, isRunning = false;


function init() {
    seedsL = []; seedsR = []; tL = 0; tR = 0;
    const config = pairData[document.getElementById('rockSelect').value];
    document.getElementById('nameL').innerText = config.nameL;
    document.getElementById('nameR').innerText = config.nameR;


    // 解像度400pxに合わせて種の密度を調整
    for(let i=0; i<65; i++) seedsL.push({x: Math.random()*400, y: Math.random()*400, color: config.colors[i % config.colors.length]});
    for(let i=0; i<15; i++) seedsR.push({
        x: Math.random()*400, y: Math.random()*400, angle: Math.random() * Math.PI * 2,
        sides: 3 + Math.floor(Math.random()*5), colorIdx: i % config.colors.length
    });


    document.querySelectorAll('.status-badge').forEach(b => { b.className = "status-badge cooling"; b.innerText = "冷却中..."; });
}


function update() {
    const config = pairData[document.getElementById('rockSelect').value];
    if (tL < 100) tL += 0.15; 
    else {
        const bL = document.getElementById('badgeL');
        bL.className = "status-badge finished"; bL.innerText = "冷却完了：等粒状組織";
    }


    if (tR < 100) tR += 2.0; 
    else {
        const bR = document.getElementById('badgeR');
        bR.className = "status-badge finished"; bR.innerText = "冷却完了：斑状組織";
    }


    draw(tL, tR, config);
    if (tL < 100 || tR < 100) animId = requestAnimationFrame(update);
    else { isRunning = false; document.getElementById('startBtn').disabled = false; }
}


function draw(timeL, timeR, config) {
    // 等粒状
    const ctxL = document.getElementById('canvasL').getContext('2d');
    const imgL = ctxL.createImageData(400, 400);
    const maxDistSqL = Math.pow(timeL * 4.2, 2); // 400px用に調整


    for (let y = 0; y < 400; y++) {
        for (let x = 0; x < 400; x++) {
            const idx = (y * 400 + x) * 4;
            let minDist = Infinity;
            let closest = null;
            seedsL.forEach(s => {
                const d2 = (x - s.x)**2 + (y - s.y)**2;
                if (d2 < minDist) { minDist = d2; closest = s; }
            });
            if (minDist < maxDistSqL) {
                imgL.data[idx] = closest.color[0]; imgL.data[idx+1] = closest.color[1];
                imgL.data[idx+2] = closest.color[2]; imgL.data[idx+3] = 255;
            }
        }
    }
    ctxL.putImageData(imgL, 0, 0);


    // 斑状
    const ctxR = document.getElementById('canvasR').getContext('2d');
    ctxR.clearRect(0, 0, 400, 400);
    const growthR = Math.min(timeR * 4.2, 60); 
    if (timeR > 30) {
        const g = config.ground;
        ctxR.fillStyle = `rgb(${g[0]},${g[1]},${g[2]})`;
        ctxR.fillRect(0, 0, 400, 400);
    }
    seedsR.forEach(s => {
        ctxR.save(); ctxR.translate(s.x, s.y); ctxR.rotate(s.angle);
        ctxR.beginPath();
        for(let i=0; i<s.sides; i++){
            const rot = (Math.PI*2/s.sides)*i;
            const r = growthR * (0.8 + Math.sin(s.x + i)*0.2);
            const px = Math.cos(rot) * r; const py = Math.sin(rot) * r;
            if(i===0) ctxR.moveTo(px, py); else ctxR.lineTo(px, py);
        }
        ctxR.closePath();
        const c = config.colors[s.colorIdx % config.colors.length];
        ctxR.fillStyle = `rgb(${c[0]},${c[1]},${c[2]})`;
        ctxR.fill(); ctxR.strokeStyle = "rgba(0,0,0,0.5)"; ctxR.lineWidth = 1; ctxR.stroke(); ctxR.restore();
    });
}


document.getElementById('startBtn').onclick = () => {
    if (isRunning) return; isRunning = true; document.getElementById('startBtn').disabled = true;
    init(); update();
};


window.onload = () => {
    const config = pairData['white'];
    document.getElementById('nameL').innerText = config.nameL;
    document.getElementById('nameR').innerText = config.nameR;
};
</script>
</body>

</html>
